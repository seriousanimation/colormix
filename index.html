<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Color Mixer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .mode-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.active {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: scale(1.05);
        }

        .mixing-section {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .color-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .color-block-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .color-block {
            width: 150px;
            height: 150px;
            border: 3px solid #333;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .color-block:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .color-block::after {
            content: 'Click for advanced';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .color-block:hover::after {
            opacity: 1;
        }

        /* NEW 2D Color Picker Styles */
        .picker-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .color-picker-area {
            width: 150px;
            height: 100px;
            position: relative;
            cursor: crosshair;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .saturation-overlay, .value-overlay {
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            border-radius: 5px;
            pointer-events: none;
        }

        .saturation-overlay {
            background: linear-gradient(to right, white, transparent);
        }

        .value-overlay {
            background: linear-gradient(to top, black, transparent);
        }

        .picker-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1.5px black, inset 0 0 0 1.5px black;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .hue-slider {
            width: 150px;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 5px;
            background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00);
            outline: none;
            cursor: pointer;
        }

        .hue-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #888;
            cursor: pointer;
        }

        .hue-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #888;
            cursor: pointer;
        }
        
        .operator {
            font-size: 3em;
            font-weight: bold;
            color: #333;
        }

        .color-info {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .color-circles {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .circle-group {
            position: relative;
            display: inline-block;
        }

        .circle-label {
            font-weight: bold;
            margin-right: 5px;
            font-size: 10px;
        }

        .color-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid #333;
            display: inline-block;
            margin-left: -8px;
            position: relative;
        }

        .color-circle:first-child {
            margin-left: 0;
        }

        .rgb-circles .color-circle:nth-child(2) { z-index: 3; }
        .rgb-circles .color-circle:nth-child(3) { z-index: 2; }
        .rgb-circles .color-circle:nth-child(4) { z-index: 1; }

        .cmy-circles .color-circle:nth-child(2) { z-index: 3; }
        .cmy-circles .color-circle:nth-child(3) { z-index: 2; }
        .cmy-circles .color-circle:nth-child(4) { z-index: 1; }

        .mixing-type-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mixing-type-btn {
            padding: 10px 20px;
            border: 2px solid #333;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #333;
        }

        .mixing-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .mixing-type-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            transform: scale(1.05);
        }

        .results-section {
            display: flex;
            justify-content: center;
            margin-top: 40px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            width: 400px;
            max-width: 100%;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        .result-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
            padding: 10px;
            border: 2px solid #333;
            border-radius: 10px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        }

        .result-color {
            width: 100%;
            height: 120px;
            border: 2px solid #333;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .mixing-visualization {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            position: relative;
            height: 60px;
        }

        .mix-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #333;
            position: relative;
            margin: 0 -10px;
        }

        .mix-circle:first-child {
            margin-left: 0;
            z-index: 1;
        }

        .mix-circle:nth-child(2) {
            z-index: 2;
        }

        .mix-circle:nth-child(3) {
            z-index: 3;
        }

        .mix-result-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #000;
            z-index: 10;
        }

        .color-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
            color: #555;
        }

        .color-value {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .color-picker {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }

        .color-picker.active {
            display: block;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        .picker-content {
            text-align: center;
        }

        .picker-title {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }

        .color-input {
            width: 200px;
            height: 50px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .picker-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .picker-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .confirm-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .cancel-btn {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
            color: white;
        }

        .picker-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .third-color {
            display: none;
        }

        .third-color.active {
            display: flex;
        }

        @media (max-width: 992px) {
             .mixing-section {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive Color Mixer</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="2">2 Color Mixing</button>
            <button class="mode-btn" data-mode="3">3 Color Mixing</button>
        </div>

        <div class="mixing-section">
            <div class="color-container">
                 <div class="picker-container">
                    <div class="color-picker-area" data-target="color1" id="picker-area-1">
                        <div class="saturation-overlay"></div>
                        <div class="value-overlay"></div>
                        <div class="picker-handle" id="picker-handle-1"></div>
                    </div>
                    <input type="range" min="0" max="360" value="0" class="hue-slider" data-target="color1" id="hue-slider-1">
                </div>
                <div class="color-block-wrapper">
                    <div class="color-block" id="color1" data-color="#FF0000"></div>
                    <div class="color-info" id="info1"></div>
                </div>
            </div>
            
            <div class="operator">+</div>
            
            <div class="color-container">
                <div class="picker-container">
                    <div class="color-picker-area" data-target="color2" id="picker-area-2">
                        <div class="saturation-overlay"></div>
                        <div class="value-overlay"></div>
                        <div class="picker-handle" id="picker-handle-2"></div>
                    </div>
                    <input type="range" min="0" max="360" value="120" class="hue-slider" data-target="color2" id="hue-slider-2">
                </div>
                <div class="color-block-wrapper">
                    <div class="color-block" id="color2" data-color="#00FF00"></div>
                    <div class="color-info" id="info2"></div>
                </div>
            </div>
            
            <div class="third-color">
                <div class="operator">+</div>
                <div class="color-container">
                     <div class="picker-container">
                        <div class="color-picker-area" data-target="color3" id="picker-area-3">
                            <div class="saturation-overlay"></div>
                            <div class="value-overlay"></div>
                            <div class="picker-handle" id="picker-handle-3"></div>
                        </div>
                        <input type="range" min="0" max="360" value="240" class="hue-slider" data-target="color3" id="hue-slider-3">
                    </div>
                    <div class="color-block-wrapper">
                        <div class="color-block" id="color3" data-color="#0000FF"></div>
                        <div class="color-info" id="info3"></div>
                    </div>
                </div>
            </div>
            
            <div class="operator">=</div>
        </div>

        <div class="mixing-type-selector">
            <button class="mixing-type-btn" data-type="additive">Additive</button>
            <button class="mixing-type-btn active" data-type="average">Average</button>
            <button class="mixing-type-btn" data-type="subtractive">Subtractive</button>
        </div>

        <div class="results-section">
            <div class="result-card">
                <div class="result-title" id="result-title">Average</div>
                <div class="result-color" id="result-color"></div>
                <div class="mixing-visualization" id="result-visualization"></div>
                <div class="color-values" id="result-values"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="color-picker" id="colorPicker">
        <div class="picker-content">
            <h3 class="picker-title">Select Color</h3>
            <input type="color" class="color-input" id="colorInput" value="#ff0000">
            <div class="picker-buttons">
                <button class="picker-btn confirm-btn" id="confirmColor">Confirm</button>
                <button class="picker-btn cancel-btn" id="cancelColor">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 2;
        let currentMixingType = 'average';
        let activeColorBlock = null;

        // NEW: State for each 2D picker (H, S, V)
        let colorStates = {
            color1: { h: 0, s: 100, v: 100 },
            color2: { h: 120, s: 100, v: 100 },
            color3: { h: 240, s: 100, v: 100 }
        };

        // --- Color conversion functions ---
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        function rgbToCmyk(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const k = 1 - Math.max(r, g, b);
            const c = (1 - r - k) / (1 - k) || 0;
            const m = (1 - g - k) / (1 - k) || 0;
            const y = (1 - b - k) / (1 - k) || 0;
            return { c: Math.round(c * 100), m: Math.round(m * 100), y: Math.round(y * 100), k: Math.round(k * 100) };
        }
        
        // NEW: HSV/HSB and RGB conversion functions for the 2D picker
        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) {
                h = 0;
            } else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: Math.round(h * 360), s: Math.round(s * 100), v: Math.round(v * 100) };
        }

        function hsvToRgb(h, s, v) {
            s /= 100; v /= 100;
            let i = Math.floor(h / 60);
            let f = h / 60 - i;
            let p = v * (1 - s);
            let q = v * (1 - f * s);
            let t = v * (1 - (1 - f) * s);
            let r, g, b;
            switch (i % 6) {
                case 0: r = v, g = t, b = p; break;
                case 1: r = q, g = v, b = p; break;
                case 2: r = p, g = v, b = t; break;
                case 3: r = p, g = q, b = v; break;
                case 4: r = t, g = p, b = v; break;
                case 5: r = v, g = p, b = q; break;
            }
            return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        }


        // --- UI Update Functions ---
        function createRGBCircles(rgb) {
            const rColor = rgb.r > 0 ? `rgb(${rgb.r}, 0, 0)` : '#000000';
            const gColor = rgb.g > 0 ? `rgb(0, ${rgb.g}, 0)` : '#000000';
            const bColor = rgb.b > 0 ? `rgb(0, 0, ${rgb.b})` : '#000000';
            return `<div class="color-circle" style="background-color: ${rColor};"></div><div class="color-circle" style="background-color: ${gColor};"></div><div class="color-circle" style="background-color: ${bColor};"></div>`;
        }

        function createCMYCircles(cmyk) {
            const cColor = cmyk.c > 0 ? `hsl(180, 100%, ${100 - cmyk.c/2}%)` : '#ffffff';
            const mColor = cmyk.m > 0 ? `hsl(300, 100%, ${100 - cmyk.m/2}%)` : '#ffffff';
            const yColor = cmyk.y > 0 ? `hsl(60, 100%, ${100 - cmyk.y/2}%)` : '#ffffff';
            return `<div class="color-circle" style="background-color: ${cColor};"></div><div class="color-circle" style="background-color: ${mColor};"></div><div class="color-circle" style="background-color: ${yColor};"></div>`;
        }
        
        function updateColorInfo(colorBlock) {
            const color = hexToRgb(colorBlock.dataset.color);
            const cmyk = rgbToCmyk(color.r, color.g, color.b);
            const infoId = colorBlock.id.replace('color', 'info');
            const rgbCircles = createRGBCircles(color);
            const cmyCircles = createCMYCircles(cmyk);
            document.getElementById(infoId).innerHTML = `
                <div>R:${color.r} G:${color.g} B:${color.b}<br>
                C:${cmyk.c} M:${cmyk.m} Y:${cmyk.y}</div>
                <div class="color-circles">
                    <div class="circle-group rgb-circles"><span class="circle-label">RGB:</span>${rgbCircles}</div>
                    <div class="circle-group cmy-circles"><span class="circle-label">CMY:</span>${cmyCircles}</div>
                </div>`;
        }

        // NEW: Update a picker's UI from its state
        function updatePickerUI(targetId, hsv) {
            const pickerArea = document.querySelector(`.color-picker-area[data-target="${targetId}"]`);
            const handle = document.querySelector(`.picker-handle[id$="-${targetId.slice(-1)}"]`);
            const slider = document.querySelector(`.hue-slider[data-target="${targetId}"]`);
            
            slider.value = hsv.h;
            pickerArea.style.backgroundColor = `hsl(${hsv.h}, 100%, 50%)`;
            handle.style.left = `${hsv.s}%`;
            handle.style.top = `${100 - hsv.v}%`;
        }
        
        // NEW: Master function to update a color based on new HSV values
        function updateColorFromPicker(targetId, hsv) {
            colorStates[targetId] = { ...hsv };
            
            const rgb = hsvToRgb(hsv.h, hsv.s, hsv.v);
            const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            
            const colorBlock = document.getElementById(targetId);
            colorBlock.style.backgroundColor = hex;
            colorBlock.dataset.color = hex;
            
            updatePickerUI(targetId, hsv);
            updateColorInfo(colorBlock);
            updateResults();
        }

        // --- Core Mixing Logic ---
        function mixColors() {
            const colors = [
                hexToRgb(document.getElementById('color1').dataset.color),
                hexToRgb(document.getElementById('color2').dataset.color)
            ];
            if (currentMode === 3) {
                colors.push(hexToRgb(document.getElementById('color3').dataset.color));
            }
            const additive = {
                r: Math.min(255, colors.reduce((sum, c) => sum + c.r, 0)),
                g: Math.min(255, colors.reduce((sum, c) => sum + c.g, 0)),
                b: Math.min(255, colors.reduce((sum, c) => sum + c.b, 0))
            };
            const subtractive = {
                r: Math.max(0, 255 - colors.reduce((sum, c) => sum + (255 - c.r), 0)),
                g: Math.max(0, 255 - colors.reduce((sum, c) => sum + (255 - c.g), 0)),
                b: Math.max(0, 255 - colors.reduce((sum, c) => sum + (255 - c.b), 0))
            };
            const average = {
                r: Math.round(colors.reduce((sum, c) => sum + c.r, 0) / colors.length),
                g: Math.round(colors.reduce((sum, c) => sum + c.g, 0) / colors.length),
                b: Math.round(colors.reduce((sum, c) => sum + c.b, 0) / colors.length)
            };
            return { additive, subtractive, average };
        }

        function createMixingVisualization(colors, resultColor) {
            let viz = colors.map((color, index) => {
                const hex = rgbToHex(color.r, color.g, color.b);
                return `<div class="mix-circle" style="background-color: ${hex}; z-index: ${colors.length - index};"></div>`;
            }).join('');
            const resultHex = rgbToHex(resultColor.r, resultColor.g, resultColor.b);
            viz += `<div class="mix-result-overlay" style="background-color: ${resultHex};"></div>`;
            return viz;
        }

        function updateResultValues(rgb) {
            const cmyk = rgbToCmyk(rgb.r, rgb.g, rgb.b);
            const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
            document.getElementById('result-values').innerHTML = `
                <div class="color-value">R: ${rgb.r}</div><div class="color-value">G: ${rgb.g}</div>
                <div class="color-value">B: ${rgb.b}</div><div class="color-value">C: ${cmyk.c}</div>
                <div class="color-value">M: ${cmyk.m}</div><div class="color-value">Y: ${cmyk.y}</div>
                <div class="color-value" style="grid-column: 1/-1;">HEX: ${hex}</div>`;
        }

        function updateResults() {
            const results = mixColors();
            const sourceColors = [
                hexToRgb(document.getElementById('color1').dataset.color),
                hexToRgb(document.getElementById('color2').dataset.color)
            ];
            if (currentMode === 3) sourceColors.push(hexToRgb(document.getElementById('color3').dataset.color));
            
            const currentResult = results[currentMixingType];
            document.getElementById('result-title').textContent = currentMixingType.charAt(0).toUpperCase() + currentMixingType.slice(1);
            document.getElementById('result-color').style.backgroundColor = rgbToHex(currentResult.r, currentResult.g, currentResult.b);
            document.getElementById('result-visualization').innerHTML = createMixingVisualization(sourceColors, currentResult);
            updateResultValues(currentResult);
        }

        // --- Event Listeners Setup ---
        
        // NEW: Setup for 2D pickers
        function setupPickers() {
            document.querySelectorAll('.color-picker-area').forEach(pickerArea => {
                const handleDrag = (e) => {
                    const rect = pickerArea.getBoundingClientRect();
                    const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
                    const y = Math.max(0, Math.min(rect.height, e.clientY - rect.top));
                    
                    const saturation = Math.round((x / rect.width) * 100);
                    const value = Math.round(100 - (y / rect.height) * 100);
                    
                    const targetId = pickerArea.dataset.target;
                    const hue = colorStates[targetId].h;
                    
                    updateColorFromPicker(targetId, { h: hue, s: saturation, v: value });
                };

                pickerArea.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    handleDrag(e);
                    
                    const onMouseMove = (moveEvent) => {
                        handleDrag(moveEvent);
                    };
                    
                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });

            document.querySelectorAll('.hue-slider').forEach(slider => {
                slider.addEventListener('input', () => {
                    const targetId = slider.dataset.target;
                    const hue = parseInt(slider.value);
                    const { s, v } = colorStates[targetId];
                    updateColorFromPicker(targetId, { h: hue, s, v });
                });
            });
        }
        
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = parseInt(btn.dataset.mode);
                document.querySelector('.third-color').classList.toggle('active', currentMode === 3);
                updateResults();
            });
        });

        document.querySelectorAll('.mixing-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mixing-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMixingType = btn.dataset.type;
                updateResults();
            });
        });

        document.querySelectorAll('.color-block').forEach(block => {
            block.addEventListener('click', () => {
                activeColorBlock = block;
                document.getElementById('colorInput').value = block.dataset.color;
                document.getElementById('overlay').classList.add('active');
                document.getElementById('colorPicker').classList.add('active');
            });
        });

        const closeColorPicker = () => {
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('colorPicker').classList.remove('active');
            activeColorBlock = null;
        };
        
        document.getElementById('confirmColor').addEventListener('click', () => {
            if (activeColorBlock) {
                const newColor = document.getElementById('colorInput').value;
                const rgb = hexToRgb(newColor);
                const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
                updateColorFromPicker(activeColorBlock.id, hsv);
            }
            closeColorPicker();
        });
        document.getElementById('cancelColor').addEventListener('click', closeColorPicker);
        document.getElementById('overlay').addEventListener('click', closeColorPicker);

        // --- Initialization ---
        function initialize() {
            // Update UI based on initial states
            Object.keys(colorStates).forEach(targetId => {
                const colorBlock = document.getElementById(targetId);
                const rgb = hsvToRgb(colorStates[targetId].h, colorStates[targetId].s, colorStates[targetId].v);
                const hex = rgbToHex(rgb.r, rgb.g, rgb.b);
                colorBlock.style.backgroundColor = hex;
                colorBlock.dataset.color = hex;

                updatePickerUI(targetId, colorStates[targetId]);
                updateColorInfo(colorBlock);
            });
            updateResults();
            setupPickers();
        }

        initialize();
    </script>
</body>
</html>
